#!/usr/bin/env ruby
require_relative '../lib/mdl'

require 'optparse'
require 'kramdown'

options = {
  :verbose => false
}
OptionParser.new do |opts|
  opts.banner = "Usage: mdl.rb [options]"

  opts.on("-v", "--[no-]verbose", "Increase verbosity") do |v|
    options[:verbose] = v
  end
end.parse!

rules = MarkdownLint::RuleSet.load_default

status = 0
ARGV.each do |filename|
  doc = MarkdownLint::Doc.new(filename)
  status = 2 if not doc.parsed.warnings.empty?
  doc.parsed.warnings.each do |w|
    puts "#{filename}: Kramdown Warning: #{w}"
  end
  rules.sort.each do |id, rule|
    error_lines = rule.check.call(doc)
    next if error_lines.nil? or error_lines.empty?
    status = 1
    error_lines.each do |line|
      puts "#{filename}:#{line}: #{id} #{rule.description}"
    end
  end
end
exit status
